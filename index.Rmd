---
title: "COVID-19 en Chubut"
author: 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    #social: menu
    social: ["facebook", "twitter"]
    #source_code: embed
    vertical_layout: fill
    logo: logo - CENPAT_48x60.png
    favicon: logo - CENPAT_48x60.png


---



```{r setup, include=FALSE}
#------------------ Packages ------------------
library(flexdashboard)
# install.packages("devtools")                                                    navbar:      - { title: "Ministerio", href: "https://example.com/about", align: right }
# devtools::install_github("RamiKrispin/coronavirus", force = TRUE)
# library(coronavirus)
# data(coronavirus)
# update_datasets()

# View(coronavirus)
# max(coronavirus$date)

`%>%` <- magrittr::`%>%`
#------------------ Parameters ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
confirmed_color <- "purple"
active_color <- "#1f77b4"
recovered_color <- "forestgreen"
death_color <- "red"


#------------------ Data ------------------

#install.packages('gsheet')
library(gsheet)
totales_País <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1GYOS5gXpVJJZ42A5UhJHJa0_WVRTsAznJ0LCqt5i-Z8/edit?usp=sharing')

totales_País$Fecha <- as.Date(totales_País$Fecha, format = "%d/%m/%Y")

totales_País_mas_reciente <-totales_País %>% 
  dplyr::filter(Fecha == max(Fecha))



library(gsheet)
informes_Chubut <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1b3NYFb2I9dUyJXmC6OucDTOpns4FQPWGaNt66opjw-A/edit?usp=sharing')

informes_Chubut$Fecha <- as.Date(informes_Chubut$Fecha, format="%d/%m/%Y")
informes_Chubut$confirmados_acum <- informes_Chubut$`Casos Confirmados acumulados`
informes_Chubut$muertos_acum <- informes_Chubut$`Casos de muerte acumulados`

informes_Chubut_mas_reciente  <- informes_Chubut %>% 
  dplyr::filter(Fecha == max(Fecha))

casos_confirmados_Chubut <- sum(informes_Chubut_mas_reciente$`Casos Confirmados`)
casos_muerte_Chubut <- sum(informes_Chubut_mas_reciente$`Casos de muerte`)

library(tidyr)
informes_Chubut_mas_reciente <- gather(informes_Chubut_mas_reciente, Clase, Conteo, -Región, -Fecha)

df <- read.csv2("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/tablas_de_entrada/df.csv")

# df_daily <- coronavirus %>%
#   dplyr::filter(Country.Region == "Argentina") %>%
#   dplyr::group_by(date, type) %>%
#   dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
#   tidyr::pivot_wider(
#     names_from = type,
#     values_from = total
#   ) %>%
#   dplyr::arrange(date) %>%
#   dplyr::ungroup() %>%
#   #dplyr::mutate(active = confirmed - death - recovered) %>%
#   dplyr::mutate(active = confirmed - death) %>%
#   dplyr::mutate(
#     confirmed_cum = cumsum(confirmed),
#     death_cum = cumsum(death),
#     # recovered_cum = cumsum(recovered),
#     active_cum = cumsum(active)
#   )
df_daily <- read.csv2("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/tablas_de_entrada/df_daily.csv", sep=",")

# df1 <- coronavirus %>% dplyr::filter(date == max(date))
df1 <- read.csv2("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/tablas_de_entrada/df1.csv", sep=",")

```

Resumen Chubut
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}

valueBox(
  value = paste(format(casos_confirmados_Chubut, big.mark = ","), "", sep = " "),
  caption = "Total de casos confirmados",
  icon = "fas fa-user-md",
  color = confirmed_color
)
```





### death {.value-box}

```{r}

valueBox(
  value = paste(format(casos_muerte_Chubut, big.mark = "."), " (",
    round(100 * casos_muerte_Chubut / casos_confirmados_Chubut, 1),
    "%)",
    sep = ""
  ),
  caption = "Casos de muerte (tasa de mortalidad)",
  icon = "fas fa-heart-broken",
  color = death_color
)
```


Row
-----------------------------------------------------------------------

### **Casos acumulados diarios** (solo Chubut)
    
```{r}

plotly::plot_ly(data = informes_Chubut) %>%
  plotly::add_trace(
    x = ~Fecha,
    # y = ~active_cum,
    y = ~confirmados_acum,
    type = "scatter",
    mode = "lines+markers",
    # name = "Active",
    name = "Confirmados",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  plotly::add_trace(
    x = ~Fecha,
    y = ~muertos_acum,
    type = "scatter",
    mode = "lines+markers",
    name = "Muertes",
    line = list(color = death_color),
    marker = list(color = death_color)
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-03-03"),
    y = 0.1,
    text = paste("Primer caso<br>en Argentina"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = 2,
    ay = -70
  ) %>%
  # plotly::add_annotations(
  #   x = as.Date("2020-02-04"),
  #   y = 1,
  #   text = paste("First case"),
  #   xref = "x",
  #   yref = "y",
  #   arrowhead = 5,
  #   arrowhead = 3,
  #   arrowsize = 1,
  #   showarrow = TRUE,
  #   ax = -10,
#   ay = -90
# ) %>%
# plotly::add_annotations(
#   x = as.Date("2020-03-11"),
#   y = 3,
#   text = paste("First death"),
#   xref = "x",
#   yref = "y",
#   arrowhead = 5,
#   arrowhead = 3,
#   arrowsize = 1,
#   showarrow = TRUE,
#   ax = -90,
#   ay = -90
# ) %>%
# plotly::add_annotations(
#   x = as.Date("2020-03-18"),
#   y = 14,
#   text = paste(
#     "New containment",
#     "",
#     "measures"
#   ),
#   xref = "x",
#   yref = "y",
#   arrowhead = 5,
#   arrowhead = 3,
#   arrowsize = 1,
#   showarrow = TRUE,
#   ax = -10,
#   ay = -90
# ) %>%
plotly::layout(
  title = "",
  yaxis = list(title = "Número acumulado de casos", range = c(-0.1,5)),
  #xaxis = list(title = "Fecha"),
  xaxis = list(
    type = 'date',
    title = "Fecha"),#, 
  #tickformat = "%d %B (%a)<br>%Y"),
  legend = list(x = 0.1, y = 0.9),
  hovermode = "compare"
)
```



Mapa Chubut
=======================================================================




Column {data-width=400}
-------------------------------------

### **Casos en Chubut** (*use los iconos + y - para acercar / alejar*)

```{r}

library(leaflet)
library(leafpop)
library(purrr)
library(sf)

nc <- sf::st_read("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/Ministerio_Salud_Chubut/Chubut_poligonos_Areas_programaticas_coronavirus.shp", quiet = TRUE)


df2 <- read.csv2("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/tablas_de_entrada/df2.csv", sep=",")
df2$Long <- as.numeric(paste(df2$Long))
df2$Lat <- as.numeric(paste(df2$Lat))

#unique(df2$type)

# cv_data_for_plot <- df2 %>%
#   # dplyr::filter(Country.Region == "Argentina") %>%
#   dplyr::filter(cases > 0) %>%
#   dplyr::group_by(Country.Region, Province.State, Lat, Long, type) %>%
#   dplyr::summarise(cases = sum(cases)) %>%
#   dplyr::mutate(log_cases = 2 * log(cases)) %>%
#   dplyr::ungroup()
cv_data_for_plot.split <- df2 %>% split(df2$type)
#pal <- colorFactor(c("blue", "green", "red", "orange", "yellow", "purple", "brown"), domain = c("Casos Sospechosos con Nexo Epidemiológico", "Casos Sospechosos IRAG sin Nexo Epidemiológico","Casos Confirmados", "Casos Confirmados fuera de la provincia", "Casos Sospechosos fuera de la provincia", "Casos Descartados", "Contactos Estrechos de casos confirmados", "Viajeros con Aislamiento Preventivo","Viajeros con Aislamiento Preventivo Finalizado"))#"confirmed", "death", "recovered"))

pal_ap <- colorFactor(c("blue", "green", "yellow", "purple"), domain = c("A.P. Comodoro Rivadavia",     
                                                                         "A.P. Norte",
                                                                         "A.P. Trelew",                             
                                                                         "A.P. Esquel"))

map_object <- leaflet() %>% addProviderTiles(providers$Esri.WorldStreetMap) %>%  addPolygons(data = nc, 
                                                                                             #fillColor = "aliceblue", 
                                                                                             #color = "grey",
                                                                                             label = ~NOMBRE,
                                                                                             color = ~ pal_ap(NOMBRE), fillOpacity = 0.1)

names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>% 
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~Long, lat = ~Lat,
        label=~as.character(cases),
        #textOnly = TRUE,
        #color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases, #log_cases
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
                                    feature.id = FALSE,
                                    row.numbers = FALSE,
                                    zcol = c("type", "cases", "Country.Region", "Province.State")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px", 'color'='black'),
                                    textsize = "15px", 
                                    direction = "auto", noHide = TRUE, offset=c(0,-12), textOnly = TRUE#,
                                    #noHide = F,
                                    #direction = "auto"
        )
      )
  })

map_object %>%
  addLayersControl(position = "topright", 
                   baseGroups = names(cv_data_for_plot.split),
                   options = layersControlOptions(collapsed = TRUE))%>%
                  addMiniMap(tiles = providers$Esri.WorldStreetMap, width = 120, height=80)# %>% hideGroup("Casos Confirmados fuera de la provincia") %>% hideGroup("Casos Descartados") %>% hideGroup("Casos Sospechosos con Nexo Epidemiológico") %>% hideGroup("Casos Sospechosos IRAG sin Nexo Epidemiológico")%>% hideGroup("Contactos Estrechos de casos confirmados")%>% hideGroup("Viajeros con Aislamiento Preventivo")  
```


Resumen País
=======================================================================

  Row {data-width=400}
-----------------------------------------------------------------------
### confirmed {.value-box}
  
```{r}
valueBox(
  value = paste(format(totales_País_mas_reciente$CasosAcum, big.mark = "."), "", sep = " "),
  caption = "Total de casos confirmados",
  icon = "fas fa-user-md",
  color = confirmed_color
)
```





### death {.value-box}

```{r}

valueBox(
  value = paste(format(totales_País_mas_reciente$FallecAcum, big.mark = "."), " (",
                format(round(100 * totales_País_mas_reciente$FallecAcum / totales_País_mas_reciente$CasosAcum, 1), decimal.mark = ","),
                "%)",
                sep = ""
  ),
  caption = "Casos de muerte (tasa de mortalidad)",
  icon = "fas fa-heart-broken",
  color = death_color
)
```

Row 
-----------------------------------------------------------------------

### Casos <br>importados

```{r}
importados <- 100*totales_País_mas_reciente$Importados/totales_País_mas_reciente$CasosAcum
gauge(round(importados, 1), min = 0, max = 100, symbol = '%', gaugeSectors(
  danger = c(80, 100), warning = c(40, 79), success = c(0, 39)
))
```

### Casos por contacto estrecho con casos confirmados

```{r}
contacto_estrecho <- 100*totales_País_mas_reciente$Estrechos/totales_País_mas_reciente$CasosAcum
gauge(round(contacto_estrecho,1), min = 0, max = 100, symbol = '%', gaugeSectors(
  danger = c(80, 100), warning = c(40, 79), success = c(0, 39)
))
```

### Casos por contacto estrecho con casos confirmados

```{r}
circulacion_comunitaria <- 100*totales_País_mas_reciente$circulacion_comunitaria/totales_País_mas_reciente$CasosAcum
gauge(round(circulacion_comunitaria,1), min = 0, max = 100, symbol = '%', gaugeSectors(
  danger = c(80, 100), warning = c(40, 79), success = c(0, 39)
))
```


### Casos aun en <br>investigación epidemiológica

```{r}
en_investigacion <- 100 - importados - contacto_estrecho - circulacion_comunitaria
gauge(round(en_investigacion,1), min = 0, max = 100, symbol = '%', gaugeSectors(
  danger = c(80, 100), warning = c(40, 79), success = c(0, 39)
))
```


Row
-----------------------------------------------------------------------
  
### **Casos confirmados acumulados por provincia**

<a href="https://raw.githubusercontent.com/lucasbandieri/testeo/gh-pages/gganim.gif" target="_blank">
<img src="/mnt/28EC75CE33EA541A/temporales/Coronavirus/testeo_web/gganim.gif" class="img-responsive" height="100%"/>    
</a>



### **Casos acumulados diarios** (todo el País)
    
```{r}
plotly::plot_ly(data = totales_País) %>%
  plotly::add_trace(
    x = ~Fecha,
    # y = ~active_cum,
    y = ~CasosAcum,
    type = "scatter",
    mode = "lines+markers",
    # name = "Active",
    name = "Confirmados",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  plotly::add_trace(
    x = ~Fecha,
    y = ~FallecAcum,
    type = "scatter",
    mode = "lines+markers",
    name = "Muertes",
    line = list(color = death_color),
    marker = list(color = death_color)
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-03-03"),
    y = 0.1,
    text = paste("Primer caso<br>en Argentina"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = 2,
    ay = -70
  ) %>%
  # plotly::add_annotations(
  #   x = as.Date("2020-02-04"),
  #   y = 1,
  #   text = paste("First case"),
  #   xref = "x",
  #   yref = "y",
  #   arrowhead = 5,
  #   arrowhead = 3,
  #   arrowsize = 1,
  #   showarrow = TRUE,
  #   ax = -10,
#   ay = -90
# ) %>%
# plotly::add_annotations(
#   x = as.Date("2020-03-11"),
#   y = 3,
#   text = paste("First death"),
#   xref = "x",
#   yref = "y",
#   arrowhead = 5,
#   arrowhead = 3,
#   arrowsize = 1,
#   showarrow = TRUE,
#   ax = -90,
#   ay = -90
# ) %>%
# plotly::add_annotations(
#   x = as.Date("2020-03-18"),
#   y = 14,
#   text = paste(
#     "New containment",
#     "",
#     "measures"
#   ),
#   xref = "x",
#   yref = "y",
#   arrowhead = 5,
#   arrowhead = 3,
#   arrowsize = 1,
#   showarrow = TRUE,
#   ax = -10,
#   ay = -90
# ) %>%
plotly::layout(
  title = "",
  yaxis = list(title = "Número acumulado de casos"), #range = c(-0.1,5)),
  #xaxis = list(title = "Fecha"),
  xaxis = list(type = 'date', title = "Fecha"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare")

```



Mapa País
=======================================================================

### **Casos en Argentina** (*use los iconos + y - para acercar / alejar*)

```{r}
# map tab added by Art Steinmetz
library(leaflet)
library(leafpop)
library(purrr)

df1 <- read.csv2("/mnt/28EC75CE33EA541A/temporales/Coronavirus/estadisticas/tablas_de_entrada/df1.csv", sep=",")
df1$Long <- as.numeric(paste(df1$Long))
df1$Lat <- as.numeric(paste(df1$Lat))

t <- list(
  family = "sans serif",
  size = 14,
  color = "grey50")

cv_data_for_plot <- df1 %>%
  # dplyr::filter(Country.Region == "Argentina") %>%
  dplyr::filter(cases > 0) %>%
  dplyr::group_by(Country.Region, Province.State, Lat, Long, type) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()
cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$type)
pal <- colorFactor(c("orange", "red", "green"), domain = c("confirmados", "muertos", "reuperados"))
map_object <- leaflet() %>% addProviderTiles(providers$OpenStreetMap)  #### Stamen.Toner
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~Long, lat = ~Lat,
        #                 label=~as.character(cases),
        color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases*1.5,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
          feature.id = FALSE,
          row.numbers = FALSE,
          zcol = c("type", "cases", "Country.Region", "Province.State")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      ) 
  })

map_object %>%
  addLayersControl(#position = "topright",
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )
```

